<div id="container">
  <!-- picked entries -->
  <div id="picked" class="form-row">
    <!-- count -->
    <span class="nr" [class.error]="entries().length < minEntries()">{{
      entries().length
    }}</span>
    <!-- max-->
    @if (maxEntries() > 1) {
    <span class="muted">/{{ maxEntries() }}</span>
    @if (remaining()) {
    <span class="muted">: -{{ remaining() }}</span>
    } }
    <!-- min -->
    @if (minEntries()) {
    <!-- min with error -->
    @if (entries().length < minEntries()) {
    <span class="error"> (min {{ minEntries() }})</span>
    }
    <!-- min without error -->
    @else {
    <span class="muted"> (min {{ minEntries() }})</span>
    } }
    <!-- list -->
    <mat-chip-listbox
      [cdkDropListDisabled]="autoSort()"
      cdkDropList
      cdkDropListOrientation="horizontal"
      (cdkDropListDropped)="onDrop($event)"
      class="chip-list"
    >
      @for (e of entries(); track e.id; let idx = $index) {
      <div class="chip-wrapper">
        <mat-chip-option
          [cdkDragDisabled]="autoSort()"
          cdkDrag
          [class.error]="!allowCustom() && e.id.startsWith('$')"
        >
          {{ renderLabel(e.value) }}
          <button
            type="button"
            matChipRemove
            (click)="removeEntry(e)"
            aria-label="Remove entry"
          >
            <mat-icon class="mat-warn">cancel</mat-icon>
          </button>
        </mat-chip-option>
      </div>
      } @empty {
      <span class="muted empty-message">{{ emptyMessage() }}</span>
      }
    </mat-chip-listbox>

    <!-- clear -->
    @if (entries().length > 0) {
    <button
      type="button"
      mat-icon-button
      matTooltip="Remove all entries"
      (click)="clear()"
      [disabled]="entries().length === 0"
    >
      <mat-icon class="mat-warn">clear</mat-icon>
    </button>
    }
    <!-- toggler -->
    <button
      type="button"
      mat-icon-button
      matTooltip="Toggle picker"
      (click)="expanded.set(!expanded())"
    >
      @if (expanded()) {
      <mat-icon class="mat-primary">publish</mat-icon>
      } @if (!expanded()) {
      <mat-icon class="mat-primary">get_app</mat-icon>
      }
    </button>
  </div>

  <!-- entries picker -->
  <div id="picker">
    <mat-expansion-panel
      [expanded]="expanded()"
      (expandedChange)="expanded.set($event)"
    >
      <div>
        <fieldset>
          <legend>available</legend>
          <cadmus-thesaurus-tree
            [entries]="availableEntries()"
            [renderLabel]="renderLabel"
            (entryChange)="onEntryChange($event)"
          />
        </fieldset>
      </div>
      @if (allowCustom()) {
      <div>
        <form [formGroup]="form" (submit)="addCustomEntry()">
          <fieldset>
            <legend>custom</legend>
            <div class="form-row">
              <mat-form-field>
                <input
                  matInput
                  type="text"
                  [formControl]="id"
                  placeholder="ID"
                />
              </mat-form-field>
              <mat-form-field>
                <input
                  matInput
                  type="text"
                  [formControl]="value"
                  placeholder="label"
                />
              </mat-form-field>
              <button
                type="submit"
                mat-icon-button
                matTooltip="Add custom entry"
                [disabled]="
                  !form.valid ||
                  (maxEntries() > 0 && entries().length >= maxEntries())
                "
              >
                <mat-icon class="mat-primary">check_circle</mat-icon>
              </button>
            </div>
          </fieldset>
        </form>
      </div>
      }
    </mat-expansion-panel>
  </div>
</div>
