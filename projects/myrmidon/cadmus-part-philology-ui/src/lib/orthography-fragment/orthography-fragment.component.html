<form [formGroup]="form" (submit)="save()">
  <mat-card appearance="outlined">
    <mat-card-header>
      <div mat-card-avatar>
        <mat-icon>textsms</mat-icon>
      </div>
      <mat-card-title
        >{{ (modelName() | titlecase) || "Orthography Fragment" }}
        {{ data()?.value?.location }}</mat-card-title
      >
      <mat-card-subtitle>
        {{ frText() }}
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="form-row">
        <!-- standard -->
        <mat-form-field>
          <mat-label>standard</mat-label>
          <input matInput [formControl]="standard" />
          @if ($any(standard).errors?.required && (standard.dirty ||
          standard.touched)) {
          <mat-error>standard required</mat-error>
          } @if ($any(standard).errors?.maxLength && (standard.dirty ||
          standard.touched)) {
          <mat-error>standard too long</mat-error>
          }
        </mat-form-field>

        <!-- language (bound) -->
        @if (langEntries()?.length) {
        <mat-form-field>
          <mat-label>language</mat-label>
          <mat-select [formControl]="language">
            @for (e of langEntries(); track e.id) {
            <mat-option [value]="e.id">{{ e.value }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
        } @else {
        <!-- language (free) -->
        <mat-form-field>
          <mat-label>language</mat-label>
          <input matInput [formControl]="language" />
          @if ($any(language).errors?.maxLength && (language.dirty ||
          language.touched)) {
          <mat-error>language too long</mat-error>
          }
        </mat-form-field>
        }

        <!-- tag -->
        <mat-form-field>
          <mat-label>tag</mat-label>
          <input matInput [formControl]="tag" />
          @if ($any(tag).errors?.maxLength && (tag.dirty || tag.touched)) {
          <mat-error>tag too long</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- operations -->
      <div>
        <button
          type="button"
          mat-flat-button
          color="primary"
          (click)="addOperation()"
        >
          <mat-icon>add_circle</mat-icon> operation
        </button>
      </div>
      @if (operations.value.length) {
      <table>
        <thead>
          <tr>
            <th></th>
            <th>type</th>
            <th>operation</th>
          </tr>
        </thead>
        <tbody>
          @for (operation of operations.value; track operation; let i = $index;
          let first = $first; let last = $last) {
          <tr [class.selected]="i === editedOperationIndex()">
            <td class="fit-width">
              <button
                type="button"
                mat-icon-button
                color="primary"
                matTooltip="Edit this operation"
                (click)="editOperation(operation, i)"
              >
                <mat-icon class="mat-primary">edit</mat-icon>
              </button>
              <button
                type="button"
                mat-icon-button
                matTooltip="Move this operation up"
                [disabled]="first"
                (click)="moveOperationUp(i)"
              >
                <mat-icon>arrow_upward</mat-icon>
              </button>
              <button
                type="button"
                mat-icon-button
                matTooltip="Move this operation down"
                [disabled]="last"
                (click)="moveOperationDown(i)"
              >
                <mat-icon>arrow_downward</mat-icon>
              </button>
              <button
                type="button"
                mat-icon-button
                color="warn"
                matTooltip="Delete this operation"
                (click)="deleteOperation(i)"
              >
                <mat-icon class="mat-warn">remove_circle</mat-icon>
              </button>
            </td>
            <td>{{ operation.type }}</td>
            <td>{{ operation.toString() }}</td>
          </tr>
          }
        </tbody>
      </table>
      } @if (editedOperation()) {
      <fieldset>
        <mat-expansion-panel
          [expanded]="editedOperation()"
          [disabled]="!editedOperation()"
        >
          <mat-expansion-panel-header>
            <mat-panel-title
              >operation #{{ editedOperationIndex() + 1 }}</mat-panel-title
            >
          </mat-expansion-panel-header>
          <cadmus-edit-operation
            [tagEntries]="tagEntries()"
            [opTagEntries]="opTagEntries()"
            [inputText]="frText()"
            [operation]="editedOperation()"
            (operationChange)="saveOperation($event!)"
            (cancelEdit)="closeOperation()"
          />
        </mat-expansion-panel>
      </fieldset>
      }
    </mat-card-content>
    <mat-card-actions>
      <cadmus-close-save-buttons
        [form]="form"
        [noSave]="userLevel < 2"
        (closeRequest)="close()"
      />
    </mat-card-actions>
  </mat-card>
</form>
