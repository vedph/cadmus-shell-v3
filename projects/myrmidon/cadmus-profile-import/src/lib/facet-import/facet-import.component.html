<!-- form -->
<form [formGroup]="form" (submit)="upload()">
  <fieldset>
    <legend>source</legend>

    <!-- file picker -->
    <div>
      <input
        #fileInput
        type="file"
        accept=".json"
        class="hidden"
        (change)="onFileSelected($event)"
      />
      <button
        type="button"
        mat-flat-button
        class="mat-primary"
        (click)="fileInput.click()"
        [disabled]="uploading()"
      >
        select file
      </button>
      <span class="file-name">{{ file.value?.name }}</span>
      @if ($any(file).errors?.required) {
      <span class="error">file required</span>
      } @if ($any(file).errors?.invalidExtension) {
      <span class="error">invalid file type (JSON only)</span>
      }
    </div>
    <br />

    <!-- mode -->
    <div class="form-row">
      <mat-form-field>
        <mat-label>mode</mat-label>
        <mat-select [formControl]="mode">
          <mat-option value="R">replace</mat-option>
          <mat-option value="S">synch</mat-option>
        </mat-select>
        <mat-hint>
          @if (mode.value === 'R') {
          <span
            >each imported facet is added or replaced if it already
            exists.</span
          >
          } @if (mode.value === 'S') {
          <span
            >all existing facets are deleted first, then the imported ones are
            added.</span
          >
          }
        </mat-hint>
        @if ($any(mode).errors?.required && (mode.dirty || mode.touched)) {
        <mat-error>mode required</mat-error>
        }
      </mat-form-field>

      <!-- dry -->
      <mat-checkbox [formControl]="dryRun">dry run</mat-checkbox>
    </div>

    <!-- submit -->
    <div style="margin-top: 16px">
      <button
        type="submit"
        mat-flat-button
        class="mat-warn"
        [disabled]="uploading() || form.invalid"
      >
        upload
      </button>
    </div>
  </fieldset>
</form>

<!-- uploading -->
@if (uploading()) {
<div>
  <div>
    <button type="button" mat-flat-button class="mat-warn" (click)="onCancel()">
      cancel
    </button>
  </div>
  <div style="margin-top: 16px">
    <mat-progress-bar max="100" [value]="uploadProgress()"></mat-progress-bar>
  </div>
</div>
}

<!-- result -->
@if (result()) {
<div>
  @if (result()!.error) {
  <div class="error">{{ result()!.error }}</div>
  } @if (result()!.importedIds.length) {
  <div>
    <div class="reload-notice">
      <mat-icon>info</mat-icon>
      <span
        >Facet definitions are cached at startup. Please reload the app to
        apply the changes.</span
      >
      <button type="button" mat-flat-button color="primary" (click)="reloadApp()">
        <mat-icon>refresh</mat-icon>
        reload app
      </button>
    </div>
    <mat-card>
      <mat-card-header>
        <mat-card-title>Imported IDs</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <ol>
          @for (id of result()!.importedIds; track id) {
          <li>{{ id }}</li>
          }
        </ol>
      </mat-card-content>
    </mat-card>
  </div>
  }
</div>
}
